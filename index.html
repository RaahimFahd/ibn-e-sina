<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ibn-e-Sina Portal</title>
<!-- Favicon / logo -->
<link rel="icon" type="image/png" href="images/image.png">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<style>
    /* General Styles */
    * { box-sizing: border-box; margin:0; padding:0; font-family: 'Roboto', sans-serif;}
    body { background: linear-gradient(to bottom, #2c2c2c, #1a1a1a); color: #fff; min-height: 100vh; display: flex; flex-direction: column; align-items: center;}
    header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #111; }
    header img { height: 50px; }
    header button { padding: 8px 16px; border: none; border-radius: 5px; background: #6a0dad; color: white; cursor: pointer; font-weight: bold; }
    h1 { margin: 30px 0 10px 0; text-align: center; }
    h2 { text-align: center; font-weight: 400; margin-bottom: 10px; color: #ccc; }
    p.description { text-align: center; max-width: 600px; margin-bottom: 30px; }
    
    /* Action Buttons */
    .actions { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; width: 250px; }
    .actions button { padding: 12px; border-radius: 8px; border: none; background: #6a0dad; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
    .actions button:hover { background: #8b2ecc; }

    /* Modal */
    .modal-bg { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index:1000; }
    .modal { background: #111; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
    .modal input, .modal textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #555; background: #222; color: white; }
    .modal button { padding: 10px; border-radius: 5px; border: none; background: #6a0dad; color: white; font-weight: bold; cursor: pointer; }
    .modal .close { background: #333; }

    /* Submissions */
    .submissions { max-width: 700px; width: 90%; margin-bottom: 50px; display: flex; flex-direction: column; gap: 10px; }
    .submission-card { background: #222; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; }
    .submission-card .votes { display: flex; gap: 10px; align-items: center; }
    .submission-card button { background: #333; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    .submission-card span { min-width: 20px; text-align: center; }
</style>
</head>

<body>

<header>
    <img src="images/image.png" alt="Ibn-e-Sina Logo">
    <button id="login-btn">Sign in with Google</button>
</header>

<h1>Talal Mukhtar</h1>
<h2>Ibn-e-Sina Headboy</h2>
<p class="description">Share your thoughts with me and I'll try my best to get back to you asap</p>

<div class="actions">
    <button id="suggestion-btn">Submit Suggestion</button>
    <button id="complaint-btn">Submit Complaint</button>
</div>

<div class="submissions" id="submissions">
    <!-- Suggestions will be listed here -->
</div>

<!-- Modal -->
<div class="modal-bg" id="modal-bg">
    <div class="modal">
        <h3 id="modal-title">Submit</h3>
        <input type="text" id="name" placeholder="Name">
        <input type="text" id="class" placeholder="Class">
        <input type="text" id="section" placeholder="Section">
        <input type="number" id="rollno" placeholder="Roll No">
        <textarea id="message" rows="4" placeholder="Your message"></textarea>
        <button id="submit-btn">Submit</button>
        <button class="close" id="close-modal">Cancel</button>
    </div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCGkF5OkclTr8Xjxe5XW3rjrP3vh4Dr2Ws",
    authDomain: "ibn-e-sina-school.firebaseapp.com",
    projectId: "ibn-e-sina-school",
    storageBucket: "ibn-e-sina-school.appspot.com",
    messagingSenderId: "897865466373",
    appId: "1:897865466373:web:107271a0b6b9e7fd36126c"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Elements
  const loginBtn = document.getElementById('login-btn');
  const suggestionBtn = document.getElementById('suggestion-btn');
  const complaintBtn = document.getElementById('complaint-btn');
  const modalBg = document.getElementById('modal-bg');
  const modalTitle = document.getElementById('modal-title');
  const submitBtn = document.getElementById('submit-btn');
  const closeModal = document.getElementById('close-modal');
  const submissionsDiv = document.getElementById('submissions');

  let currentType = null;
  let user = null;

  // Google Sign-In
  loginBtn.onclick = () => {
    if (!user) {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).then(res => {
        user = res.user;
        loginBtn.textContent = "Logout";
      });
    } else {
      auth.signOut().then(() => {
        user = null;
        loginBtn.textContent = "Sign in with Google";
      });
    }
  };

  auth.onAuthStateChanged(u => {
    user = u;
    loginBtn.textContent = user ? "Logout" : "Sign in with Google";
  });

  // Open modal
  suggestionBtn.onclick = () => openModal('suggestion');
  complaintBtn.onclick = () => openModal('complaint');

  function openModal(type) {
    if (!user) { alert("Please sign in first!"); return; }
    currentType = type;
    modalTitle.textContent = type === 'suggestion' ? "Submit Suggestion" : "Submit Complaint";
    modalBg.style.display = "flex";
  }

  closeModal.onclick = () => { modalBg.style.display = "none"; }

  // Cooldown tracking
  async function checkCooldown(email, type) {
    const doc = await db.collection('cooldowns').doc(email).get();
    if (!doc.exists) return false;
    const data = doc.data();
    const now = Date.now();
    if (type === 'suggestion' && data.suggestion && now - data.suggestion.toMillis() < 7*24*60*60*1000) return true;
    if (type === 'complaint' && data.complaint && now - data.complaint.toMillis() < 24*60*60*1000) return true;
    return false;
  }

  // Submit
  submitBtn.onclick = async () => {
    if (!user) { alert("Please sign in first!"); return; }

    const name = document.getElementById('name').value.trim();
    const className = document.getElementById('class').value.trim();
    const section = document.getElementById('section').value.trim();
    const rollno = document.getElementById('rollno').value.trim();
    const message = document.getElementById('message').value.trim();

    if(!name || !className || !section || !rollno || !message) { alert("Fill all fields!"); return; }

    if(await checkCooldown(user.email, currentType)) {
      alert("You are still in cooldown period for " + currentType);
      return;
    }

    await db.collection('entries').add({
      type: currentType,
      name, class: className, section, rollno, message, email: user.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      upvotes:0, downvotes:0
    });

    const update = {};
    update[currentType] = firebase.firestore.FieldValue.serverTimestamp();
    await db.collection('cooldowns').doc(user.email).set(update, {merge:true});

    modalBg.style.display = "none";
    alert("✅ Submitted successfully!");

    // clear inputs
    ['name','class','section','rollno','message'].forEach(id => document.getElementById(id).value='');

    loadSubmissions();
  }

  // Load suggestions only
  async function loadSubmissions() {
    submissionsDiv.innerHTML = '';
    const snapshot = await db.collection('entries').where('type','==','suggestion').orderBy('timestamp','desc').get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const card = document.createElement('div');
      card.className = 'submission-card';
      card.innerHTML = `
        <strong>${data.name} (Class ${data.class}-${data.section}, Roll ${data.rollno})</strong>
        <p>${data.message}</p>
        <div class="votes">
          <button class="upvote">⬆️</button>
          <span class="upcount">${data.upvotes}</span>
          <button class="downvote">⬇️</button>
          <span class="downcount">${data.downvotes}</span>
        </div>
      `;
      const up = card.querySelector('.upvote');
      const down = card.querySelector('.downvote');
      const upcount = card.querySelector('.upcount');
      const downcount = card.querySelector('.downcount');

      up.onclick = async () => {
        await db.collection('entries').doc(doc.id).update({upvotes: firebase.firestore.FieldValue.increment(1)});
        upcount.textContent = parseInt(upcount.textContent)+1;
      }
      down.onclick = async () => {
        await db.collection('entries').doc(doc.id).update({downvotes: firebase.firestore.FieldValue.increment(1)});
        downcount.textContent = parseInt(downcount.textContent)+1;
      }

      submissionsDiv.appendChild(card);
    });
  }

  loadSubmissions();
</script>
</body>
</html>
