<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ibn-e-Sina Portal</title>
<link rel="icon" type="image/png" href="images/image.png">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Roboto',sans-serif;}
body{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding-top:90px;color:#fff;transition:background 0.8s;}
header{width:100%;display:flex;justify-content:space-between;align-items:center;padding:10px 20px;position:fixed;top:0;z-index:100;background:linear-gradient(to bottom, rgba(17,17,17,0.9), rgba(17,17,17,0));transition:background 0.5s;}
header img{height:50px;}
header button{padding:8px 16px;border:none;border-radius:5px;background:#6a0dad;color:white;cursor:pointer;font-weight:bold;}
h1{text-align:center;margin:20px 0 10px 0;}
h2{text-align:center;font-weight:400;margin-bottom:10px;color:#ccc;}
p.description{text-align:center;max-width:600px;margin-bottom:20px;}
.profile-img{width:150px;height:150px;border-radius:50%;display:block;margin:0 auto 20px auto;}
.actions{display:flex;flex-direction:column;gap:15px;margin-bottom:30px;width:250px;}
.actions button{padding:12px;border-radius:8px;border:none;background:#6a0dad;color:white;cursor:pointer;font-size:16px;font-weight:bold;transition:0.3s;}
.actions button:hover{background:#8b2ecc;}
.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;}
.modal{background:#111;padding:20px;border-radius:10px;width:90%;max-width:400px;display:flex;flex-direction:column;gap:15px;}
.modal input,.modal textarea{width:100%;padding:10px;border-radius:5px;border:1px solid #555;background:#222;color:white;}
.modal button{padding:10px;border-radius:5px;border:none;background:#6a0dad;color:white;font-weight:bold;cursor:pointer;}
.modal .close{background:#333;}
#feedback-message{margin-top:10px;text-align:center;font-weight:bold;}
#suggestions-feed{width:90%;max-width:700px;margin-bottom:50px;}
.suggestion-card{background:#222;padding:15px;border-radius:8px;margin:10px 0;}
.suggestion-card button{margin-right:10px;}
</style>
</head>
<body>

<header>
  <img src="images/image.png" alt="Ibn-e-Sina Logo">
  <button id="login-btn">Sign in with Google</button>
</header>

<img src="images/person.png" alt="Talal Mukhtar" class="profile-img">
<h1>Talal Mukhtar</h1>
<h2>Ibn-e-Sina Headboy</h2>
<p class="description">Share your thoughts with me and I'll try my best to get back to you asap</p>

<div class="actions">
  <button id="suggestion-btn">Submit Suggestion</button>
  <button id="complaint-btn">Submit Complaint</button>
</div>

<div id="feedback-message"></div>

<h2>View Suggestions</h2>
<div id="suggestions-feed"></div>

<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <h3 id="modal-title">Submit</h3>
    <input type="text" id="name" placeholder="Name">
    <input type="text" id="class" placeholder="Class">
    <input type="text" id="section" placeholder="Section">
    <input type="number" id="rollno" placeholder="Roll No">
    <textarea id="message" rows="4" placeholder="Your message"></textarea>
    <button id="submit-btn">Submit</button>
    <button class="close" id="close-modal">Cancel</button>
  </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCGkF5OkclTr8Xjxe5XW3rjrP3vh4Dr2Ws",
    authDomain: "ibn-e-sina-school.firebaseapp.com",
    projectId: "ibn-e-sina-school",
    storageBucket: "ibn-e-sina-school.appspot.com",
    messagingSenderId: "897865466373",
    appId: "1:897865466373:web:107271a0b6b9e7fd36126c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById('login-btn');
const suggestionBtn = document.getElementById('suggestion-btn');
const complaintBtn = document.getElementById('complaint-btn');
const modalBg = document.getElementById('modal-bg');
const modalTitle = document.getElementById('modal-title');
const submitBtn = document.getElementById('submit-btn');
const closeModal = document.getElementById('close-modal');
const feedContainer = document.getElementById('suggestions-feed');
const feedbackMessage = document.getElementById('feedback-message');

let currentType = null;
let user = null;

// Login/Logout
loginBtn.onclick = () => {
  if(!user){
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(res => { user=res.user; loginBtn.textContent="Logout"; });
  } else {
    auth.signOut().then(()=>{ user=null; loginBtn.textContent="Sign in with Google"; });
  }
};
auth.onAuthStateChanged(u => { user=u; loginBtn.textContent=user?"Logout":"Sign in with Google"; });

// Random Gradient
function randomGradient() {
  const colors = [
    ['#2c2c2c','#111111'], ['#4b0082','#000000'], ['#1e3c72','#2a5298'],
    ['#ff512f','#dd2476'], ['#11998e','#38ef7d']
  ];
  const gradient = colors[Math.floor(Math.random()*colors.length)];
  document.body.style.background = `linear-gradient(to bottom, ${gradient[0]}, ${gradient[1]})`;
}

// Show modal
function openModal(type){
  if(!user){ showLoginPopup(); return; }
  currentType=type;
  modalTitle.textContent=type==='suggestion'?"Submit Suggestion":"Submit Complaint";
  modalBg.style.display="flex";
}
suggestionBtn.onclick = ()=>openModal('suggestion');
complaintBtn.onclick = ()=>openModal('complaint');
closeModal.onclick = ()=>{ modalBg.style.display='none'; }

function showLoginPopup(){
  feedbackMessage.textContent="⚠️ Please sign in first!";
  setTimeout(()=>{feedbackMessage.textContent='';},3000);
}

// Load Suggestions
async function loadSuggestions(){
  feedContainer.innerHTML='Loading...';
  const snapshot = await db.collection('suggestions')
                        .where('type','==','suggestion')
                        .orderBy('timestamp','desc')
                        .get();
  feedContainer.innerHTML='';
  snapshot.forEach(doc=>{
    const data = doc.data();
    const card = document.createElement('div');
    card.className='suggestion-card';
    card.innerHTML=`
      <p><strong>${data.name} (Class ${data.class}${data.section?'-'+data.section:''})</strong></p>
      <p>${data.message}</p>
      <div>
        <button class="upvote">⬆ ${data.votes?.up||0}</button>
        <button class="downvote">⬇ ${data.votes?.down||0}</button>
      </div>
    `;
    feedContainer.appendChild(card);

    const upBtn = card.querySelector('.upvote');
    const downBtn = card.querySelector('.downvote');

    upBtn.onclick = async ()=>{
      if(!user){ showLoginPopup(); return; }
      const ref = db.collection('suggestions').doc(doc.id);
      await ref.update({'votes.up': firebase.firestore.FieldValue.increment(1)});
      data.votes = {...data.votes, up: (data.votes?.up||0)+1};
      upBtn.textContent = `⬆ ${data.votes.up}`;
    };
    downBtn.onclick = async ()=>{
      if(!user){ showLoginPopup(); return; }
      const ref = db.collection('suggestions').doc(doc.id);
      await ref.update({'votes.down': firebase.firestore.FieldValue.increment(1)});
      data.votes = {...data.votes, down: (data.votes?.down||0)+1};
      downBtn.textContent = `⬇ ${data.votes.down}`;
    };
  });
}

// Submit form
submitBtn.onclick = async ()=>{
  if(!user){ showLoginPopup(); return; }
  submitBtn.disabled=true;
  const name=document.getElementById('name').value.trim();
  const cls=document.getElementById('class').value.trim();
  const section=document.getElementById('section').value.trim();
  const rollno=document.getElementById('rollno').value.trim();
  const message=document.getElementById('message').value.trim();
  if(!name||!cls||!rollno||!message){ feedbackMessage.textContent="Fill all required fields!"; submitBtn.disabled=false; return; }

  const type = currentType;
  const now=Date.now();
  const limitRef = db.collection('limits').doc(user.uid);
  const limitSnap = await limitRef.get();
  let allow=true;
  if(limitSnap.exists){
    const data = limitSnap.data();
    if(type==='suggestion' && data.lastSuggestion && now-data.lastSuggestion<7*24*60*60*1000) allow=false;
    if(type==='complaint' && data.lastComplaint && now-data.lastComplaint<24*60*60*1000) allow=false;
  }

  if(!allow){ feedbackMessage.textContent=`You've reached the limit for ${type}!`; submitBtn.disabled=false; return; }

  const newDoc = await db.collection('suggestions').add({
    type,message,name,class:cls,section,rollno,votes:{up:0,down:0},timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
  await limitRef.set({
    ...(limitSnap.exists?limitSnap.data():{}),
    ...(type==='suggestion'?{lastSuggestion:now}:{lastComplaint:now})
  });

  feedbackMessage.textContent="✅ Submitted successfully!";
  submitBtn.disabled=false;
  modalBg.style.display='none';
  document.getElementById('name').value='';
  document.getElementById('class').value='';
  document.getElementById('section').value='';
  document.getElementById('rollno').value='';
  document.getElementById('message').value='';
  loadSuggestions();
};

window.onload = ()=>{
  randomGradient();
  loadSuggestions();
};
</script>
</body>
</html>
