<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ibn-e-Sina Portal</title>
<link rel="icon" type="image/png" href="images/image.png">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Roboto',sans-serif;}
body{min-height:100vh;display:flex;flex-direction:column;align-items:center;transition:background 0.8s;}
header{
  width:100%;display:flex;justify-content:space-between;align-items:center;
  padding:10px 20px;background:linear-gradient(to bottom,rgba(17,17,17,0.9),rgba(17,17,17,0));
  position:fixed;top:0;z-index:100;transition:background 0.5s;
}
body{padding-top:90px;}
header img{height:50px;}
header button{padding:8px 16px;border:none;border-radius:5px;background:#6a0dad;color:white;cursor:pointer;font-weight:bold;}
h1{text-align:center;margin:20px 0 10px 0;color:white;}
h2{text-align:center;font-weight:400;margin-bottom:10px;color:#ccc;}
p.description{text-align:center;max-width:600px;margin-bottom:20px;color:white;}
.profile-img{width:150px;height:150px;border-radius:50%;display:block;margin:0 auto 20px auto;}
.actions{display:flex;flex-direction:column;gap:15px;margin-bottom:30px;width:250px;}
.actions button{padding:12px;border-radius:8px;border:none;background:#6a0dad;color:white;cursor:pointer;font-size:16px;font-weight:bold;transition:0.3s;}
.actions button:hover{background:#8b2ecc;}
.loading-container {display: flex;justify-content: center;margin-top: 20px;}
.loading-gif {width: 80px;height: auto;}
.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;}
.modal{background:#111;padding:20px;border-radius:10px;width:90%;max-width:400px;display:flex;flex-direction:column;gap:15px;}
.modal input,.modal textarea{width:100%;padding:10px;border-radius:5px;border:1px solid #555;background:#222;color:white;}
.modal button{padding:10px;border-radius:5px;border:none;background:#6a0dad;color:white;font-weight:bold;cursor:pointer;}
.modal .close{background:#333;}
  .modal h3 {
    color: white; margin-bottom: 10px;text-align: center;}
.vote-container{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:5px;}
.vote-btn{cursor:pointer;background:#444;border:none;padding:5px 10px;border-radius:5px;color:white;}
.vote-count{color:white;font-weight:bold;}
#suggestions-container{margin-top:20px;width:90%;max-width:600px;display:flex;flex-direction:column;gap:15px;color: white;
    text-align: center;}
.suggestion-card{background:#222;padding:15px;border-radius:10px;color:white;}
</style>
</head>
<body>

<header>
  <img src="images/image.png" alt="Ibn-e-Sina Logo">
  <button id="login-btn">Sign in with Google</button>
</header>

<img src="images/person.png" alt="Talal Mukhtar" class="profile-img">
<h1>Talal Mukhtar</h1>
<h2>Ibn-e-Sina Headboy</h2>
<p class="description">Share your thoughts with me and I'll try my best to get back to you asap</p>

<div class="actions">
  <button id="suggestion-btn">Submit Suggestion</button>
  <button id="complaint-btn">Submit Complaint</button>
</div>

  <div id="loading-container" class="loading-container" style="display:none;">
  <span style="color:white;">Loading...</span>
</div>
//start

  <html>
  <head>
    <title>reCAPTCHA demo: Simple page</title>
    <script src="https://www.google.com/recaptcha/enterprise.js" async defer></script>
  </head>
  <body>
    <form action="" method="POST">
      <div class="g-recaptcha" data-sitekey="6LeF68grAAAAAExc7Q242JOXNbLZFmnHP8GcCsnT" data-action="LOGIN"></div>
      <br/>
      <input type="submit" value="Submit">
    </form>
  </body>
</html>

  //end

<div id="suggestions-container"></div>

<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <h3 id="modal-title">Submit</h3>
    <input type="text" id="name" placeholder="Name">
    <input type="text" id="class" placeholder="Class">
    <input type="text" id="section" placeholder="Section">
    <input type="number" id="rollno" placeholder="Roll No">
    <textarea id="message" rows="4" placeholder="Your message"></textarea>
    <button id="submit-btn">Submit</button>
    <button class="close" id="close-modal">Cancel</button>
  </div>
</div>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyCGkF5OkclTr8Xjxe5XW3rjrP3vh4Dr2Ws",
    authDomain: "ibn-e-sina-school.firebaseapp.com",
    projectId: "ibn-e-sina-school",
    storageBucket: "ibn-e-sina-school.appspot.com",
    messagingSenderId: "897865466373",
    appId: "1:897865466373:web:107271a0b6b9e7fd36126c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById('login-btn');
const suggestionBtn = document.getElementById('suggestion-btn');
const complaintBtn = document.getElementById('complaint-btn');
const modalBg = document.getElementById('modal-bg');
const modalTitle = document.getElementById('modal-title');
const submitBtn = document.getElementById('submit-btn');
const closeModal = document.getElementById('close-modal');
const suggestionsContainer = document.getElementById('suggestions-container');

let currentType = null;
let user = null;

function getRandomGradient(){
  const darks=[
    'linear-gradient(to bottom,#1a1a1a,#2c2c2c)',
    'linear-gradient(to bottom,#0d0d2c,#1a1a4d)',
    'linear-gradient(to bottom,#1a1a1a,#003300)',
    'linear-gradient(to bottom,#111111,#220022)'
  ];
  return darks[Math.floor(Math.random()*darks.length)];
}
document.body.style.background=getRandomGradient();

loginBtn.onclick = () => {
  if(!user){
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(res => { user=res.user; loginBtn.textContent="Logout"; loadSuggestions(); });
  } else {
    auth.signOut().then(()=>{ user=null; loginBtn.textContent="Sign in with Google"; });
  }
};
auth.onAuthStateChanged(u => { 
  user=u; 
  loginBtn.textContent=user?"Logout":"Sign in with Google"; 
  if(user) loadSuggestions();
});

function showLoginPopup(){
  const popup = document.createElement('div');
  popup.style.position='fixed';
  popup.style.top='50%';
  popup.style.left='50%';
  popup.style.transform='translate(-50%,-50%)';
  popup.style.background='#111';
  popup.style.padding='20px';
  popup.style.borderRadius='10px';
  popup.style.zIndex='10000';
  popup.style.textAlign='center';
  popup.style.color='white';
  popup.textContent="Please sign in first!";
  const okBtn=document.createElement('button');
  okBtn.textContent="OK";
  okBtn.style.marginTop='10px';
  okBtn.onclick=()=>document.body.removeChild(popup);
  popup.appendChild(okBtn);
  document.body.appendChild(popup);
}

function openModal(type){
  if(!user){ showLoginPopup(); return; }
  currentType=type;
  modalTitle.textContent=type==='suggestion'?"Submit Suggestion":"Submit Complaint";
  modalBg.style.display="flex";
}

suggestionBtn.onclick = ()=>openModal('suggestion');
complaintBtn.onclick = ()=>openModal('complaint');
closeModal.onclick = ()=>{ modalBg.style.display='none'; }

function canSubmit(type) {
  const key = `lastSubmit_${type}`;
  const last = localStorage.getItem(key);
  if (!last) return true;

  const now = Date.now();
  const waitTime = type === 'complaint' ? 24*60*60*1000 : 7*24*60*60*1000; // ms
  const elapsed = now - parseInt(last);

  if (elapsed >= waitTime) return true;
  const hoursLeft = Math.ceil((waitTime - elapsed)/3600000);
  alert(`⏳ You must wait ${hoursLeft} hour(s) before submitting another ${type}.`);
  return false;
}

submitBtn.onclick = async () => {
  if(!user){ showLoginPopup(); return; }

  const name = document.getElementById('name').value.trim();
  const className = document.getElementById('class').value.trim();
  const section = document.getElementById('section').value.trim();
  const rollno = document.getElementById('rollno').value.trim();
  const message = document.getElementById('message').value.trim();

  if(!name || !className || !section || !rollno || !message){ 
    alert("Fill all fields!"); 
    return; 
  }

  const key = `${user.email}_${currentType}`;
  const lastTime = localStorage.getItem(key);
  const now = Date.now();
  const limit = currentType === 'suggestion' ? 7*24*60*60*1000 : 24*60*60*1000; // ms

  if(lastTime && now - parseInt(lastTime) < limit){
    const msLeft = limit - (now - parseInt(lastTime));
    const hours = Math.floor(msLeft / (1000*60*60));
    const minutes = Math.floor((msLeft % (1000*60*60)) / (1000*60));
    alert(`⏳ Please wait ${hours}h ${minutes}m before submitting another ${currentType}.`);
    return;
  }

  submitBtn.disabled = true;

  try{
    // Send to Google Apps Script
    await fetch('https://script.google.com/macros/s/AKfycbxbXiK4j4xHddht46t48_SeDTrIMHG01HTSIdRLnPSvph8eZ1R9iPI-wdGNfaCZjALf/exec',{
      method:'POST',
      body: JSON.stringify({name, class: className, section, rollno, message, type: currentType, email: user.email}),
      headers:{'Content-Type':'application/json'},
      mode:'no-cors'
    });

    // Mark submission timestamp
    localStorage.setItem(key, Date.now());

    // Save to Firestore
    await db.collection('submissions').add({
      name,
      class: className,
      section,
      rollno,
      message,
      type: currentType,
      email: user.email,
      upvotes: 0,
      downvotes: 0,
      upvoters: [],
      downvoters: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("✅ Submitted successfully!");
    modalBg.style.display = 'none';
    ['name','class','section','rollno','message'].forEach(id => document.getElementById(id).value='');
    loadSuggestions();

  } catch(err){ 
    alert("❌ Error submitting form: " + err.message); 
  }

  submitBtn.disabled = false;
};




async function loadSuggestions(){

  suggestionsContainer.innerHTML='Loading...';

  try{

    const snapshot=await db.collection('submissions').where('type','==','suggestion').get();

    suggestionsContainer.innerHTML='';

    snapshot.forEach(doc=>{

      const data=doc.data();

      const card=document.createElement('div');

      card.className='suggestion-card';

      card.innerHTML=`<strong>${data.name}</strong> (${data.class}-${data.section})<p>${data.message}</p>

      <div class="vote-container">

        <button class="vote-btn upvote">⬆</button>

        <span class="vote-count">${data.upvotes||0}</span>

        <button class="vote-btn downvote">⬇</button>

        <span class="vote-count">${data.downvotes||0}</span>

      </div>`;

      const upBtn=card.querySelector('.upvote');

      const downBtn=card.querySelector('.downvote');



      upBtn.onclick=async ()=>{

        if(!user) { showLoginPopup(); return; }

        const userId=user.uid;

        const docRef=db.collection('submissions').doc(doc.id);

        const upvoters=data.upvoters||[];

        const downvoters=data.downvoters||[];

        if(upvoters.includes(userId)||downvoters.includes(userId)) return;

        await docRef.update({

          upvotes:(data.upvotes||0)+1,

          upvoters:firebase.firestore.FieldValue.arrayUnion(userId)

        });

        loadSuggestions();

      };

      downBtn.onclick=async ()=>{
        if(!user) { showLoginPopup(); return; }
        const userId=user.uid;
        const docRef=db.collection('submissions').doc(doc.id);
        const upvoters=data.upvoters||[];
        const downvoters=data.downvoters||[];
        if(upvoters.includes(userId)||downvoters.includes(userId)) return;
        await docRef.update({
          downvotes:(data.downvotes||0)+1,
          downvoters:firebase.firestore.FieldValue.arrayUnion(userId)
        });
        loadSuggestions();
      };

      suggestionsContainer.appendChild(card);
    });
  }catch(err){ suggestionsContainer.innerHTML='❌ Failed to load suggestions'; }
}
</script>

</body>
</html>













