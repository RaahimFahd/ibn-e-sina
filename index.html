<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ibn-e-Sina Portal</title>
<link rel="icon" type="image/png" href="images/image.png">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Roboto',sans-serif;}
body{min-height:100vh;display:flex;flex-direction:column;align-items:center;transition: background 1s;}
header{
  width:100%;display:flex;justify-content:space-between;align-items:center;
  padding:10px 20px;background: linear-gradient(to bottom, rgba(17,17,17,0.9), rgba(17,17,17,0));
  position: fixed;top:0;z-index:100;transition: background 0.5s;
}
body{padding-top:90px;}
header img{height:50px;}
header button{padding:8px 16px;border:none;border-radius:5px;background:#6a0dad;color:white;cursor:pointer;font-weight:bold;}
h1{text-align:center;margin:20px 0 10px 0;}
h2{text-align:center;font-weight:400;margin-bottom:10px;color:#ccc;}
p.description{text-align:center;max-width:600px;margin-bottom:20px;}
.profile-img{width:150px;height:150px;border-radius:50%;display:block;margin:0 auto 20px auto;}
.actions{display:flex;flex-direction:column;gap:15px;margin-bottom:30px;width:250px;}
.actions button{padding:12px;border-radius:8px;border:none;background:#6a0dad;color:white;cursor:pointer;font-size:16px;font-weight:bold;transition:0.3s;}
.actions button:hover{background:#8b2ecc;}
.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;}
.modal{background:#111;padding:20px;border-radius:10px;width:90%;max-width:400px;display:flex;flex-direction:column;gap:15px;}
.modal input,.modal textarea{width:100%;padding:10px;border-radius:5px;border:1px solid #555;background:#222;color:white;}
.modal button{padding:10px;border-radius:5px;border:none;background:#6a0dad;color:white;font-weight:bold;cursor:pointer;}
.modal .close{background:#333;}
#suggestions-list{max-width:600px;margin-top:20px;width:90%;}
.suggestion-card{background:#222;padding:15px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.suggestion-text{color:white;flex:1;margin-right:10px;}
.vote-btn{background:none;border:none;color:white;font-weight:bold;cursor:pointer;margin-left:5px;font-size:16px;}
.vote-count{margin-left:5px;font-weight:bold;}
</style>
</head>
<body>

<header>
  <img src="images/image.png" alt="Ibn-e-Sina Logo">
  <button id="login-btn">Sign in with Google</button>
</header>

<img src="images/person.png" alt="Talal Mukhtar" class="profile-img">
<h1>Talal Mukhtar</h1>
<h2>Ibn-e-Sina Headboy</h2>
<p class="description">Share your thoughts with me and I'll try my best to get back to you asap</p>

<div class="actions">
  <button id="suggestion-btn">Submit Suggestion</button>
  <button id="complaint-btn">Submit Complaint</button>
</div>

<div id="suggestions-list"></div>

<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <h3 id="modal-title">Submit</h3>
    <input type="text" id="name" placeholder="Name">
    <input type="text" id="class" placeholder="Class">
    <input type="text" id="section" placeholder="Section">
    <input type="number" id="rollno" placeholder="Roll No">
    <textarea id="message" rows="4" placeholder="Your message"></textarea>
    <button id="submit-btn">Submit</button>
    <button class="close" id="close-modal">Cancel</button>
    <p id="rate-msg" style="color:#f66;margin-top:10px;"></p>
  </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCGkF5OkclTr8Xjxe5XW3rjrP3vh4Dr2Ws",
    authDomain: "ibn-e-sina-school.firebaseapp.com",
    projectId: "ibn-e-sina-school",
    storageBucket: "ibn-e-sina-school.appspot.com",
    messagingSenderId: "897865466373",
    appId: "1:897865466373:web:107271a0b6b9e7fd36126c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById('login-btn');
const suggestionBtn = document.getElementById('suggestion-btn');
const complaintBtn = document.getElementById('complaint-btn');
const modalBg = document.getElementById('modal-bg');
const modalTitle = document.getElementById('modal-title');
const submitBtn = document.getElementById('submit-btn');
const closeModal = document.getElementById('close-modal');
const rateMsg = document.getElementById('rate-msg');
const suggestionsList = document.getElementById('suggestions-list');

let currentType = null;
let user = null;

const darkGradients = [
  "linear-gradient(to bottom, #1a1a1a, #2c2c2c)",
  "linear-gradient(to bottom, #0b0b1f, #1a1a3c)",
  "linear-gradient(to bottom, #001a00, #003300)",
  "linear-gradient(to bottom, #1a001a, #3c003c)"
];
document.body.style.background = darkGradients[Math.floor(Math.random()*darkGradients.length)];

loginBtn.onclick = () => {
  if(!user){
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(res => { user=res.user; loginBtn.textContent="Logout"; loadSuggestions(); });
  } else {
    auth.signOut().then(()=>{ user=null; loginBtn.textContent="Sign in with Google"; });
  }
};
auth.onAuthStateChanged(u => { user=u; loginBtn.textContent=user?"Logout":"Sign in with Google"; loadSuggestions(); });

function showLoginPopup(){
  const popup = document.createElement('div');
  popup.style.position='fixed';
  popup.style.top='50%';
  popup.style.left='50%';
  popup.style.transform='translate(-50%,-50%)';
  popup.style.background='#111';
  popup.style.padding='20px';
  popup.style.borderRadius='10px';
  popup.style.zIndex='10000';
  popup.style.textAlign='center';
  popup.style.color='white';
  popup.textContent="Please sign in first!";
  const okBtn=document.createElement('button');
  okBtn.textContent="OK";
  okBtn.style.marginTop='10px';
  okBtn.onclick=()=>document.body.removeChild(popup);
  popup.appendChild(okBtn);
  document.body.appendChild(popup);
}

function openModal(type){
  if(!user){ showLoginPopup(); return; }
  currentType=type;
  modalTitle.textContent=type==='suggestion'?"Submit Suggestion":"Submit Complaint";
  modalBg.style.display="flex";
}

suggestionBtn.onclick = ()=>openModal('suggestion');
complaintBtn.onclick = ()=>openModal('complaint');
closeModal.onclick = ()=>{ modalBg.style.display='none'; rateMsg.textContent=''; }

submitBtn.onclick = async ()=>{
  if(!user){ showLoginPopup(); return; }
  const name=document.getElementById('name').value.trim();
  const className=document.getElementById('class').value.trim();
  const section=document.getElementById('section').value.trim();
  const rollno=document.getElementById('rollno').value.trim();
  const message=document.getElementById('message').value.trim();
  if(!name||!className||!section||!rollno||!message){ alert("Fill all fields!"); return; }

  submitBtn.disabled=true;
  rateMsg.textContent='';
  const userEmail = user.email;

  // Rate limiter example: exclude owner
  if(userEmail!=="fahdraahim@gmail.com"){
    const lastSub = await db.collection("submissions")
      .where("email","==",userEmail)
      .where("type","==",currentType)
      .orderBy("timestamp","desc")
      .limit(1).get();
    if(!lastSub.empty){
      const diff = (Date.now()-lastSub.docs[0].data().timestamp)/1000;
      if(diff<60){
        rateMsg.textContent=`You are rate limited. Wait ${Math.ceil(60-diff)}s`;
        submitBtn.disabled=false; return;
      }
    }
  }

  try{
    await db.collection("submissions").add({
      name,class:className,section,rollno,message,type:currentType,email:userEmail,
      timestamp:Date.now(),upvotes:0,downvotes:0,votes:{}
    });
    modalBg.style.display='none';
    ['name','class','section','rollno','message'].forEach(id=>document.getElementById(id).value='');
    loadSuggestions();
  } catch(err){ alert("❌ Error submitting form: "+err.message); }
  submitBtn.disabled=false;
};

// Load suggestions
async function loadSuggestions(){
  suggestionsList.innerHTML='';
  if(!user) return;
  const query = await db.collection("submissions").where("type","==","suggestion").orderBy("timestamp","desc").get();
  query.forEach(doc=>{
    const data = doc.data();
    const card = document.createElement('div');
    card.className='suggestion-card';
    const text = document.createElement('div');
    text.className='suggestion-text';
    text.textContent=data.message;
    card.appendChild(text);

    const upBtn = document.createElement('button');
    upBtn.className='vote-btn';
    upBtn.textContent='⬆';
    const downBtn = document.createElement('button');
    downBtn.className='vote-btn';
    downBtn.textContent='⬇';

    const upCount = document.createElement('span');
    upCount.className='vote-count';
    upCount.textContent=data.upvotes||0;
    const downCount = document.createElement('span');
    downCount.className='vote-count';
    downCount.textContent=data.downvotes||0;

    upBtn.onclick = async ()=>{
      const votes = data.votes||{};
      if(votes[user.uid]==1) return;
      if(votes[user.uid]==-1){ data.downvotes--; votes[user.uid]=1; data.upvotes++; }
      else { votes[user.uid]=1; data.upvotes++; }
      await db.collection("submissions").doc(doc.id).update({upvotes:data.upvotes,downvotes:data.downvotes,votes});
      loadSuggestions();
    };
    downBtn.onclick = async ()=>{
      const votes = data.votes||{};
      if(votes[user.uid]==-1) return;
      if(votes[user.uid]==1){ data.upvotes--; votes[user.uid]=-1; data.downvotes++; }
      else { votes[user.uid]=-1; data.downvotes++; }
      await db.collection("submissions").doc(doc.id).update({upvotes:data.upvotes,downvotes:data.downvotes,votes});
      loadSuggestions();
    };

    card.appendChild(upBtn);
    card.appendChild(upCount);
    card.appendChild(downBtn);
    card.appendChild(downCount);

    suggestionsList.appendChild(card);
  });
}
</script>

</body>
</html>
