<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISC Student Portal</title>
    <link rel="icon" type="image/png" href="images/image.png" style="border-radius: 8px 0 0 0;">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <style>
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        .gradient-text {
            background: linear-gradient(45deg, #6a0dad, #9b59b6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glow-hover:hover {
            box-shadow: 0 0 15px rgba(106, 13, 173, 0.6);
            position: relative;
        }
        .glow-hover:hover::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            background: rgba(106, 13, 173, 0.3);
            animation: glowFade 1s ease-out forwards;
            z-index: -1;
        }
        @keyframes glowFade {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.2); }
        }
        .toast {
            animation: slideIn 0.5s forwards, fadeOut 0.5s 3s forwards;
        }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100px); }
        }
        .spinner {
            width: 50px;
            height: 50px;
            position: relative;
        }
        .spinner:before, .spinner:after {
            content: "";
            position: absolute;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }
        .spinner:before {
            width: 100%;
            height: 100%;
            border: 4px solid rgba(106, 13, 173, 0.2);
        }
        .spinner:after {
            width: 70%;
            height: 70%;
            top: 15%;
            left: 15%;
            border: 4px solid transparent;
            border-top-color: #6a0dad;
            border-bottom-color: #9b59b6;
            animation-duration: 1s;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .vote-btn:hover {
            transform: scale(1.1);
        }
        .upvote:hover {
            color: #4ade80;
        }
        .downvote:hover {
            color: #f87171;
        }
        #vanta-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white">
    <div id="vanta-bg"></div>
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
        <div class="spinner"></div>
    </div>

    <header class="fixed top-0 left-0 right-0 z-40 bg-gradient-to-b from-gray-900/90 to-transparent backdrop-blur-sm py-3 px-6 flex justify-between items-center shadow-lg">
        <div class="flex items-center">
            <img src="images/image.png" alt="ISC Logo" class="h-12 rounded-tl-lg">
        </div>

        <div class="absolute left-1/2 transform -translate-x-1/2">
            <a href="why-vote.html" class="text-lg font-medium text-white hover:text-purple-300 smooth-transition relative group">
                Why Vote?
                <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-purple-500 group-hover:w-full smooth-transition"></span>
            </a>
        </div>

        <div class="flex space-x-3">
            <button id="login-btn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-800 rounded-lg font-medium hover:from-purple-700 hover:to-purple-900 smooth-transition glow-hover shadow-md">
                Sign in with Google
            </button>
            <button id="email-login-btn" class="px-4 py-2 bg-gray-700 rounded-lg font-medium hover:bg-gray-600 smooth-transition shadow-md">
                Sign in with Email
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 pt-28 pb-16 max-w-4xl">
        <div class="text-center mb-10" data-aos="fade-up">
            <img src="images/person.png" alt="Talal Mukhtar" class="w-40 h-40 rounded-full mx-auto shadow-xl border-4 border-purple-500 animate-float">
            <h1 class="text-4xl md:text-5xl font-bold mt-6 mb-2 gradient-text">Vote For Talal Mukhtar</h1>
            <h2 class="text-xl md:text-2xl text-purple-300 mb-6">Candidate for ISC Headboy</h2>
            <p class="text-lg text-gray-300 max-w-3xl mx-auto">
                Share your thoughts with me and I'll try my best to get back to you as soon as possible
            </p>
        </div>

        <div class="flex flex-col items-center space-y-5 mb-16" data-aos="fade-up" data-aos-delay="100">
            <button id="suggestion-btn" class="w-full max-w-xs px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl font-semibold text-lg hover:from-purple-700 hover:to-indigo-700 transform hover:scale-105 smooth-transition shadow-lg">
                <i data-feather="message-square" class="inline mr-2"></i> Submit Suggestion
            </button>
            <button id="complaint-btn" class="w-full max-w-xs px-6 py-3 bg-gradient-to-r from-red-600 to-pink-600 rounded-xl font-semibold text-lg hover:from-red-700 hover:to-pink-700 transform hover:scale-105 smooth-transition shadow-lg">
                <i data-feather="alert-triangle" class="inline mr-2"></i> Submit Complaint
            </button>
        </div>

        <div id="suggestions-container" class="space-y-6" data-aos="fade-up" data-aos-delay="200"></div>
    </main>

    <!-- Modals -->
    <div id="modal-bg" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform transition-all duration-300 scale-95">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-center gradient-text"></h3>
            <div class="space-y-4">
                <input type="text" id="name" placeholder="Name" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <input type="text" id="class" placeholder="Class" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <input type="text" id="section" placeholder="Section" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <input type="number" id="rollno" placeholder="Roll No" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <textarea id="message" rows="4" placeholder="Your message" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="submit-btn" class="flex-1 py-2 bg-gradient-to-r from-purple-600 to-purple-800 rounded-lg font-medium hover:from-purple-700 hover:to-purple-900 smooth-transition">
                    Submit
                </button>
                <button id="close-modal" class="flex-1 py-2 bg-gray-600 rounded-lg font-medium hover:bg-gray-500 smooth-transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="email-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform transition-all duration-300 scale-95">
            <h3 class="text-2xl font-bold mb-4 text-center gradient-text">Email Login / Signup</h3>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Email" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <div class="relative">
                    <input type="password" id="password-input" placeholder="Password" class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 pr-10">
                    <span id="toggle-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white cursor-pointer">
                        <i data-feather="eye"></i>
                    </span>
                </div>
            </div>
            <div class="flex flex-col space-y-3 mt-6">
                <button id="email-submit-btn" class="w-full py-2 bg-gradient-to-r from-purple-600 to-purple-800 rounded-lg font-medium hover:from-purple-700 hover:to-purple-900 smooth-transition">
                    Login / Signup
                </button>
                <button id="reset-password-btn" class="w-full py-2 bg-gray-600 rounded-lg font-medium hover:bg-gray-500 smooth-transition">
                    Reset Password
                </button>
                <button class="close-btn w-full py-2 bg-gray-700 rounded-lg font-medium hover:bg-gray-600 smooth-transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 space-y-3 z-50"></div>

    <footer class="fixed bottom-4 right-4 text-sm text-gray-400 z-40">
        Made by Raahim Fahd, 9 Green | 
        <a href="https://github.com/iscsuggest/isc" target="_blank" class="text-purple-400 hover:text-purple-300 smooth-transition">Source code</a>
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCGkF5OkclTr8Xjxe5XW3rjrP3vh4Dr2Ws",
            authDomain: "ibn-e-sina-school.firebaseapp.com",
            projectId: "ibn-e-sina-school",
            storageBucket: "ibn-e-sina-school.appspot.com",
            messagingSenderId: "897865466373",
            appId: "1:897865466373:web:107271a0b6b9e7fd36126c"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Initialize animations and effects
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });

        // Vanta.js background
        VANTA.NET({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: 0x6a0dad,
            backgroundColor: 0x111111,
            points: 10.00,
            maxDistance: 20.00,
            spacing: 15.00
        });

        // DOM elements
        const loginBtn = document.getElementById('login-btn');
        const emailLoginBtn = document.getElementById('email-login-btn');
        const suggestionBtn = document.getElementById('suggestion-btn');
        const complaintBtn = document.getElementById('complaint-btn');
        const modalBg = document.getElementById('modal-bg');
        const modalTitle = document.getElementById('modal-title');
        const submitBtn = document.getElementById('submit-btn');
        const closeModal = document.getElementById('close-modal');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const loadingOverlay = document.getElementById('loading-overlay');

        const emailModal = document.getElementById('email-modal');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const togglePassword = document.getElementById('toggle-password');
        const emailSubmitBtn = document.getElementById('email-submit-btn');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const emailCloseBtn = emailModal.querySelector('.close-btn');

        let currentType = null;
        let user = null;
        
        // Utility functions
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }
        
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
        
        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast px-5 py-3 rounded-lg shadow-lg font-medium ${
                type === 'error' ? 'bg-red-600' : 
                type === 'success' ? 'bg-green-600' : 'bg-gray-800'
            }`;
            toast.textContent = msg;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        function animateModal(modal, show) {
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.style.opacity = '1';
                    modal.querySelector('div').style.transform = 'scale(1)';
                }, 10);
            } else {
                modal.style.opacity = '0';
                modal.querySelector('div').style.transform = 'scale(0.95)';
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        
        // Event listeners
        loginBtn.onclick = async () => {
            if (!user) {
                try {
                    showLoading();
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const res = await auth.signInWithPopup(provider);
                    user = res.user;
                    loginBtn.innerHTML = '<i data-feather="log-out" class="inline mr-2"></i> Logout';
                    emailLoginBtn.classList.add('hidden');
                    await loadSuggestions();
                    showToast('Welcome! You are now signed in.', 'success');
                } catch (err) {
                    showToast(err.message, 'error');
                } finally {
                    hideLoading();
                }
            } else {
                await auth.signOut();
                user = null;
                loginBtn.innerHTML = '<i data-feather="log-in" class="inline mr-2"></i> Sign in with Google';
                emailLoginBtn.classList.remove('hidden');
                showToast('You have been signed out.', 'info');
            }
        };
        
        emailLoginBtn.onclick = () => {
            animateModal(emailModal, true);
            emailInput.value = '';
            passwordInput.value = '';
        };
        
        togglePassword.onclick = () => {
            passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
            feather.replace();
        };
        
        emailCloseBtn.onclick = () => animateModal(emailModal, false);
        emailModal.onclick = e => {
            if (e.target === emailModal) animateModal(emailModal, false);
        };
        
        // Firebase auth state listener
        auth.onAuthStateChanged(async u => {
            user = u && u.emailVerified ? u : null;
            if (user) {
                loginBtn.innerHTML = '<i data-feather="log-out" class="inline mr-2"></i> Logout';
                emailLoginBtn.classList.add('hidden');
                await loadSuggestions();
            } else {
                loginBtn.innerHTML = '<i data-feather="log-in" class="inline mr-2"></i> Sign in with Google';
                emailLoginBtn.classList.remove('hidden');
            }
        });
        
        // Modal functions
        function openModal(type) {
            if (!user) {
                showToast("🔒 Please sign in first!", 'error');
                return;
            }
            currentType = type;
            modalTitle.textContent = type === 'suggestion' ? "Submit Suggestion" : "Submit Complaint";
            animateModal(modalBg, true);
            
            // Clear previous inputs and focus on name
            ['name', 'class', 'section', 'rollno', 'message'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('name').focus();
        }
        
        suggestionBtn.onclick = () => openModal('suggestion');
        complaintBtn.onclick = () => openModal('complaint');
        closeModal.onclick = () => animateModal(modalBg, false);
        
        // Submission handler
        submitBtn.onclick = async () => {
            if (!user) {
                showToast("Please sign in first!", 'error');
                return;
            }
            
            const name = document.getElementById('name').value.trim();
            const className = document.getElementById('class').value.trim();
            const section = document.getElementById('section').value.trim();
            const rollno = document.getElementById('rollno').value.trim();
            const message = document.getElementById('message').value.trim();
            
            if (!name || !className || !section || !rollno || !message) {
                showToast("Please fill all fields!", 'error');
                return;
            }
            
            // Rate limiting
            const key = `${user.email}_${currentType}`;
            const lastTime = localStorage.getItem(key);
            const now = Date.now();
            const limit = currentType === 'suggestion' ? 7 * 24 * 60 * 60 * 1000 : 24 * 60 * 60 * 1000;
            
            if (lastTime && now - parseInt(lastTime) < limit) {
                const msLeft = limit - (now - parseInt(lastTime));
                const hours = Math.floor(msLeft / (1000 * 60 * 60));
                const minutes = Math.floor((msLeft % (1000 * 60 * 60)) / (1000 * 60));
                showToast(`Please wait ${hours}h ${minutes}m before submitting another ${currentType}.`, 'error');
                return;
            }
            
            submitBtn.disabled = true;
            showLoading();
            
            try {
                // Profanity check
                const combinedText = `${name} ${className} ${section} ${rollno} ${message}`;
                const response = await fetch('https://vector.profanity.dev', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: combinedText })
                });
                const data = await response.json();
                
                if (data.score && data.score > 0.9) {
                    showToast("Your message contains inappropriate words. Please remove them.", 'error');
                    return;
                }
                
                // Send to Google Apps Script with CORS and response handling
                const gscriptResponse = await fetch('https://script.google.com/macros/s/AKfycbxbXiK4j4xHddht46t48_SeDTrIMHG01HTSIdRLnPSvph8eZ1R9iPI-wdGNfaCZjALf/exec', {
                    method: 'POST',
                    body: JSON.stringify({
                        name, 
                        class: className, 
                        section, 
                        rollno, 
                        message, 
                        type: currentType, 
                        email: user.email
                    }),
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!gscriptResponse.ok) {
                    throw new Error('Failed to send email notification');
                }

                const gscriptData = await gscriptResponse.json();
                if (!gscriptData.success) {
                    throw new Error(gscriptData.error || 'Email notification failed');
                }
                
                // Save to Firestore
                await db.collection('submissions').add({
                    name, 
                    class: className, 
                    section, 
                    rollno, 
                    message,
                    type: currentType, 
                    email: user.email, 
                    upvotes: 0, 
                    downvotes: 0, 
                    upvoters: [], 
                    downvoters: [],
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                localStorage.setItem(key, Date.now());
                animateModal(modalBg, false);
                await loadSuggestions();
                showToast("🎉 Submitted successfully!", 'success');
                
                // Enhanced confetti celebration
                confetti({
                    particleCount: 250,
                    spread: 100,
                    origin: { y: 0.6 },
                    colors: ['#6a0dad', '#9b59b6', '#ffffff'],
                    shapes: ['circle', 'square'],
                    scalar: 1.2
                });
            } catch (err) {
                if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
                    showToast("Invalid Credentials, try again", 'error');
                } else {
                    showToast(`Error: ${err.message}`, 'error');
                }
            } finally {
                submitBtn.disabled = false;
                hideLoading();
            }
        };
        
        // Load suggestions
        async function loadSuggestions() {
            if (!user) {
                suggestionsContainer.innerHTML = '<p class="text-center text-gray-400">Please sign in to see suggestions.</p>';
                return;
            }
            
            suggestionsContainer.innerHTML = '<div class="flex justify-center"><div class="spinner"></div></div>';
            
            try {
                const snapshot = await db.collection('submissions')
                    .where('type', '==', 'suggestion')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                if (snapshot.empty) {
                    suggestionsContainer.innerHTML = '<p class="text-center text-gray-400">No suggestions yet. Be the first to submit one!</p>';
                    return;
                }
                
                suggestionsContainer.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-xl p-5 shadow-lg hover:shadow-xl smooth-transition';
                    card.innerHTML = `
                        <div class="flex flex-col space-y-2">
                            <div class="flex justify-between items-center">
                                <strong class="text-lg text-purple-300">${data.name}</strong>
                                <span class="text-sm text-gray-400">${data.class}-${data.section}</span>
                            </div>
                            <p class="text-gray-300">${data.message}</p>
                            <div class="flex items-center justify-center space-x-4 mt-3">
                                <button class="vote-btn upvote flex items-center space-x-1 bg-gray-700 px-3 py-1 rounded-lg hover:bg-gray-600 smooth-transition">
                                    <i data-feather="thumbs-up" class="w-4 h-4"></i>
                                    <span class="vote-count">${data.upvotes || 0}</span>
                                </button>
                                <button class="vote-btn downvote flex items-center space-x-1 bg-gray-700 px-3 py-1 rounded-lg hover:bg-gray-600 smooth-transition">
                                    <i data-feather="thumbs-down" class="w-4 h-4"></i>
                                    <span class="vote-count">${data.downvotes || 0}</span>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    const docRef = db.collection('submissions').doc(doc.id);
                    
                    // Upvote handler
                    const upBtn = card.querySelector('.upvote');
                    upBtn.onclick = async () => {
                        if (!user) {
                            showToast("Please sign in first!", 'error');
                            return;
                        }
                        
                        const snap = await docRef.get();
                        const docData = snap.data();
                        
                        if ((docData.upvoters || []).includes(user.uid)) {
                            // Remove upvote
                            await docRef.update({
                                upvotes: firebase.firestore.FieldValue.increment(-1),
                                upvoters: firebase.firestore.FieldValue.arrayRemove(user.uid)
                            });
                            showToast("Upvote removed", 'info');
                        } else if ((docData.downvoters || []).includes(user.uid)) {
                            // Switch downvote → upvote
                            await docRef.update({
                                downvotes: firebase.firestore.FieldValue.increment(-1),
                                downvoters: firebase.firestore.FieldValue.arrayRemove(user.uid),
                                upvotes: firebase.firestore.FieldValue.increment(1),
                                upvoters: firebase.firestore.FieldValue.arrayUnion(user.uid)
                            });
                            showToast("Switched to upvote", 'info');
                        } else {
                            // Add upvote
                            await docRef.update({
                                upvotes: firebase.firestore.FieldValue.increment(1),
                                upvoters: firebase.firestore.FieldValue.arrayUnion(user.uid)
                            });
                            showToast("Upvoted!", 'success');
                        }
                        
                        await loadSuggestions();
                    };
                    
                    // Downvote handler
                    const downBtn = card.querySelector('.downvote');
                    downBtn.onclick = async () => {
                        if (!user) {
                            showToast("Please sign in first!", 'error');
                            return;
                        }
                        
                        const snap = await docRef.get();
                        const docData = snap.data();
                        
                        if ((docData.downvoters || []).includes(user.uid)) {
                            // Remove downvote
                            await docRef.update({
                                downvotes: firebase.firestore.FieldValue.increment(-1),
                                downvoters: firebase.firestore.FieldValue.arrayRemove(user.uid)
                            });
                            showToast("Downvote removed", 'info');
                        } else if ((docData.upvoters || []).includes(user.uid)) {
                            // Switch upvote → downvote
                            await docRef.update({
                                upvotes: firebase.firestore.FieldValue.increment(-1),
                                upvoters: firebase.firestore.FieldValue.arrayRemove(user.uid),
                                downvotes: firebase.firestore.FieldValue.increment(1),
                                downvoters: firebase.firestore.FieldValue.arrayUnion(user.uid)
                            });
                            showToast("Switched to downvote", 'info');
                        } else {
                            // Add downvote
                            await docRef.update({
                                downvotes: firebase.firestore.FieldValue.increment(1),
                                downvoters: firebase.firestore.FieldValue.arrayUnion(user.uid)
                            });
                            showToast("Downvoted", 'info');
                        }
                        
                        await loadSuggestions();
                    };
                    
                    suggestionsContainer.appendChild(card);
                });
                
                feather.replace();
            } catch (err) {
                suggestionsContainer.innerHTML = '<p class="text-center text-red-400">Failed to load suggestions. Please try again later.</p>';
            }
        }
        
        // Email login/signup handler
        emailSubmitBtn.onclick = async () => {
            const email = emailInput.value.trim();
            const pass = passwordInput.value.trim();
            
            if (!email || !pass) {
                showToast("Please fill all fields!", 'error');
                return;
            }
            
            try {
                showLoading();
                let cred;
                
                try {
                    cred = await auth.signInWithEmailAndPassword(email, pass);
                } catch (e) {
                    if (e.code === 'auth/user-not-found') {
                        cred = await auth.createUserWithEmailAndPassword(email, pass);
                        await cred.user.sendEmailVerification();
                        showToast("Account created. Please verify your email (check inbox/junk folder).", 'info');
                        await auth.signOut();
                        return;
                    }
                    throw e;
                }
                
                if (!cred.user.emailVerified) {
                    showToast("Email not verified. Please check your inbox/junk folder.", 'error');
                    await cred.user.sendEmailVerification();
                    await auth.signOut();
                    return;
                }
                
                user = cred.user;
                showToast("Logged in successfully!", 'success');
                animateModal(emailModal, false);
                loginBtn.innerHTML = '<i data-feather="log-out" class="inline mr-2"></i> Logout';
                emailLoginBtn.classList.add('hidden');
                await loadSuggestions();
            } catch (err) {
                if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
                    showToast("Invalid Credentials, try again", 'error');
                } else {
                    showToast(`Error: ${err.message}`, 'error');
                }
                await auth.signOut();
                user = null;
            } finally {
                hideLoading();
            }
        };
        
        // Password reset handler
        resetPasswordBtn.onclick = async () => {
            const email = emailInput.value.trim();
            
            if (!email) {
                showToast("Please enter your email first", 'error');
                return;
            }
            
            try {
                showLoading();
                await auth.sendPasswordResetEmail(email);
                showToast("Password reset email sent. Check your inbox/junk folder.", 'info');
                await auth.signOut();
                user = null;
                animateModal(emailModal, false);
            } catch (err) {
                showToast(`Error: ${err.message}`, 'error');
            } finally {
                hideLoading();
            }
        };
        
        // Initialize Feather Icons
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
        });
    </script>
</body>
</html>
