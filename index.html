<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ibn-e-Sina Portal</title>
<link rel="icon" type="image/png" href="images/image.png">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Roboto',sans-serif;}
body{min-height:100vh;display:flex;flex-direction:column;align-items:center;color:white;transition:background 1s;}
header{width:100%;display:flex;justify-content:space-between;align-items:center;padding:10px 20px;position:fixed;top:0;background:rgba(0,0,0,0.6);z-index:100;}
header img{height:50px;}
header button{padding:8px 16px;border:none;border-radius:5px;background:#6a0dad;color:white;cursor:pointer;font-weight:bold;}
body{padding-top:100px;}
.profile-img{width:150px;height:150px;border-radius:50%;display:block;margin:0 auto 20px auto;}
.actions{display:flex;flex-direction:column;gap:15px;margin-bottom:30px;width:250px;}
.actions button{padding:12px;border-radius:8px;border:none;background:#6a0dad;color:white;cursor:pointer;font-size:16px;font-weight:bold;transition:0.3s;}
.actions button:hover{background:#8b2ecc;}
.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;}
.modal{background:#111;padding:20px;border-radius:10px;width:90%;max-width:400px;display:flex;flex-direction:column;gap:15px;}
.modal input,.modal textarea{width:100%;padding:10px;border-radius:5px;border:1px solid #555;background:#222;color:white;}
.modal button{padding:10px;border-radius:5px;border:none;background:#6a0dad;color:white;font-weight:bold;cursor:pointer;}
.modal .close{background:#333;}
.suggestion-card{background:rgba(255,255,255,0.1);margin-bottom:10px;padding:10px;border-radius:8px;display:flex;flex-direction:column;}
.vote{display:flex;gap:10px;margin-top:5px;}
.vote button{background:transparent;color:white;border:none;cursor:pointer;font-size:16px;}
</style>
</head>
<body>

<header>
  <img src="images/image.png" alt="Ibn-e-Sina Logo">
  <button id="login-btn">Sign in with Google</button>
</header>

<img src="images/person.png" alt="Talal Mukhtar" class="profile-img">
<h1>Talal Mukhtar</h1>
<h2>Ibn-e-Sina Headboy</h2>
<p class="description">Share your thoughts with me and I'll try my best to get back to you asap</p>

<div class="actions">
  <button id="suggestion-btn">Submit Suggestion</button>
  <button id="complaint-btn">Submit Complaint</button>
</div>

<h1 style="text-align:center;">View Suggestions</h1>
<div id="suggestions-container" style="width:90%;max-width:800px;margin-bottom:50px;">Loading...</div>

<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <h3 id="modal-title">Submit</h3>
    <input type="text" id="name" placeholder="Name">
    <input type="text" id="class" placeholder="Class">
    <input type="text" id="section" placeholder="Section">
    <input type="number" id="rollno" placeholder="Roll No">
    <textarea id="message" rows="4" placeholder="Your message"></textarea>
    <button id="submit-btn">Submit</button>
    <button class="close" id="close-modal">Cancel</button>
  </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCGkF5OkclTr8Xjxe5XW3rjrP3vh4Dr2Ws",
    authDomain: "ibn-e-sina-school.firebaseapp.com",
    projectId: "ibn-e-sina-school",
    storageBucket: "ibn-e-sina-school.appspot.com",
    messagingSenderId: "897865466373",
    appId: "1:897865466373:web:107271a0b6b9e7fd36126c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById('login-btn');
const suggestionBtn = document.getElementById('suggestion-btn');
const complaintBtn = document.getElementById('complaint-btn');
const modalBg = document.getElementById('modal-bg');
const modalTitle = document.getElementById('modal-title');
const submitBtn = document.getElementById('submit-btn');
const closeModal = document.getElementById('close-modal');
const suggestionsContainer = document.getElementById('suggestions-container');

let currentType=null;
let user=null;

// random dark gradient
function randomGradient(){
  const gradients=[
    'linear-gradient(135deg,#0a0a0a,#1a1a1a)',
    'linear-gradient(135deg,#0a0a0a,#001a33)',
    'linear-gradient(135deg,#0a0a0a,#003300)',
    'linear-gradient(135deg,#0a0a0a,#33001a)'
  ];
  document.body.style.background=gradients[Math.floor(Math.random()*gradients.length)];
}
randomGradient();

// Auth
loginBtn.onclick = ()=>{
  if(!user){
    const provider=new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  } else auth.signOut();
};
auth.onAuthStateChanged(u=>{
  user=u;
  loginBtn.textContent=user?"Logout":"Sign in with Google";
  loadSuggestions();
});

// Modal
function showLoginPopup(){
  alert("Please login first!");
}
function openModal(type){
  if(!user){ showLoginPopup(); return; }
  currentType=type;
  modalTitle.textContent=type==='suggestion'?"Submit Suggestion":"Submit Complaint";
  modalBg.style.display='flex';
}
suggestionBtn.onclick = ()=>openModal('suggestion');
complaintBtn.onclick = ()=>openModal('complaint');
closeModal.onclick = ()=>{ modalBg.style.display='none'; }

// Submit
submitBtn.onclick = async ()=>{
  if(!user){ showLoginPopup(); return; }
  const name=document.getElementById('name').value.trim();
  const className=document.getElementById('class').value.trim();
  const section=document.getElementById('section').value.trim();
  const rollno=document.getElementById('rollno').value.trim();
  const message=document.getElementById('message').value.trim();
  if(!name||!className||!section||!rollno||!message){ alert("Fill all fields!"); return; }
  submitBtn.disabled=true;
  try{
    await db.collection('suggestions').add({
      type:currentType,
      name,class:className,section,rollno:Number(rollno),message,
      timestamp:firebase.firestore.FieldValue.serverTimestamp(),
      votes:{up:{},down:{}}
    });
    alert("✅ Submitted successfully!");
    modalBg.style.display='none';
    ['name','class','section','rollno','message'].forEach(id=>document.getElementById(id).value='');
    loadSuggestions();
  } catch(e){ console.error(e); alert("❌ Error submitting form"); }
  submitBtn.disabled=false;
};

// Load Suggestions with votes
async function loadSuggestions(){
  const snapshot = await db.collection('suggestions').orderBy('timestamp','desc').get();
  suggestionsContainer.innerHTML='';
  snapshot.forEach(doc=>{
    if(doc.data().type!=='suggestion') return;
    const votes=doc.data().votes||{up:{},down:{}};
    const card=document.createElement('div');
    card.className='suggestion-card';
    card.innerHTML=`
      <strong>${doc.data().name}</strong> (${doc.data().class}-${doc.data().section})<br>
      ${doc.data().message}
      <div class="vote">
        <button class="upvote">⬆ ${Object.keys(votes.up||{}).length}</button>
        <button class="downvote">⬇ ${Object.keys(votes.down||{}).length}</button>
      </div>
    `;
    suggestionsContainer.appendChild(card);

    card.querySelector('.upvote').onclick = async ()=>{
      if(!user){ showLoginPopup(); return; }
      const uid=user.uid;
      if(votes.up[uid]) delete votes.up[uid]; else votes.up[uid]=true;
      delete votes.down[uid];
      await db.collection('suggestions').doc(doc.id).update({votes});
      loadSuggestions();
    };
    card.querySelector('.downvote').onclick = async ()=>{
      if(!user){ showLoginPopup(); return; }
      const uid=user.uid;
      if(votes.down[uid]) delete votes.down[uid]; else votes.down[uid]=true;
      delete votes.up[uid];
      await db.collection('suggestions').doc(doc.id).update({votes});
      loadSuggestions();
    };
  });
}
</script>
</body>
</html>
