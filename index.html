<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ISC Student Portal</title>
<link rel="icon" type="image/png" href="images/image.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
:root {
  --primary: #6a0dad;
  --primary-light: #8b2ecc;
  --primary-dark: #4f0785;
  --secondary: #444;
  --secondary-light: #555;
  --dark-bg: #121212;
  --card-bg: #1e1e1e;
  --text: #ffffff;
  --text-secondary: #cccccc;
  --success: #4CAF50;
  --error: #f44336;
  --warning: #ff9800;
  --info: #2196F3;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
}

body {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: linear-gradient(135deg, #2c2c2c 0%, #3a1c71 30%, #2c3e50 100%);
  position: relative;
  color: var(--text);
  padding-top: 80px;
}

.site-header {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: rgba(17, 17, 17, 0.95);
  backdrop-filter: blur(10px);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid rgba(106, 13, 173, 0.3);
}

.header-left {
  flex: 0 0 auto;
}

.header-left img {
  height: 45px;
  display: block;
  transition: transform 0.3s ease;
  border-radius: 50%;
}

.header-left img:hover {
  transform: scale(1.05);
}

.header-center {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
}

.nav-link {
  color: white;
  text-decoration: none;
  font-size: 16px;
  padding: 8px 16px;
  position: relative;
  display: inline-flex;
  align-items: center;
  font-weight: 500;
  border-radius: 6px;
  transition: all 0.3s ease;
}

.nav-link i {
  margin-right: 8px;
  font-size: 18px;
}

.nav-link:hover {
  background: rgba(106, 13, 173, 0.2);
}

.nav-link::after {
  content: "";
  position: absolute;
  left: 0;
  height: 2px;
  background: var(--primary);
  bottom: -2px;
  width: 100%;
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 0.3s ease;
}

.nav-link:hover::after {
  transform: scaleX(1);
}

.header-right {
  flex: 0 0 auto;
  display: flex;
  gap: 10px;
  align-items: center;
}

.header-right button {
  padding: 8px 16px;
  border-radius: 6px;
  border: none;
  background: var(--primary);
  color: white;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.header-right button:hover {
  background: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.header-right .secondary {
  background: var(--secondary);
}

.header-right .secondary:hover {
  background: var(--secondary-light);
}


  .profile-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 20px 0;
  padding: 0 20px;
  text-align: center;
}

.profile-img {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 20px;
  border: 4px solid var(--primary);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

.profile-img:hover {
  transform: scale(1.03);
  box-shadow: 0 8px 20px rgba(106, 13, 173, 0.3);
}

h1 {
  font-size: 2.2rem;
  margin-bottom: 8px;
  background: linear-gradient(90deg, var(--primary-light), var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 700;
}

h2 {
  font-size: 1.2rem;
  margin-bottom: 15px;
  color: var(--text-secondary);
  font-weight: 400;
}

.description {
  text-align: center;
  max-width: 700px;
  margin-bottom: 30px;
  color: var(--text-secondary);
  line-height: 1.6;
  font-size: 1.05rem;
}
.actions {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 40px;
  width: 280px;
}

.actions button {
  padding: 14px;
  border-radius: 10px;
  border: none;
  background: var(--primary);
  color: white;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: 0 4px 10px rgba(106, 13, 173, 0.3);
}

.actions button:hover {
  background: var(--primary-light);
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(106, 13, 173, 0.4);
}

.actions button:active {
  transform: translateY(0);
}

#suggestions-container {
  margin-top: 20px;
  width: 90%;
  max-width: 800px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  color: var(--text);
  text-align: center;
  margin-bottom: 80px;
}

.suggestion-card {
  background: var(--card-bg);
  padding: 20px;
  border-radius: 12px;
  color: var(--text);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  border-left: 4px solid var(--primary);
}

.suggestion-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.suggestion-card strong {
  color: var(--primary-light);
  font-size: 1.1rem;
}

.suggestion-card p {
  margin: 12px 0;
  line-height: 1.6;
  color: var(--text-secondary);
}

.vote-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-top: 15px;
}

.vote-btn {
  cursor: pointer;
  background: var(--secondary);
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  color: white;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s ease;
}

.vote-btn:hover {
  background: var(--secondary-light);
  transform: scale(1.05);
}

.vote-count {
  color: white;
  font-weight: bold;
  min-width: 30px;
  text-align: center;
}

.modal-bg, .popup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  justify-content: center;
  align-items: center;
  opacity: 0;
  transform: translateY(-50px);
  transition: all 0.3s ease;
  z-index: 2000;
}

.modal-bg.show, .popup.show {
  display: flex;
  opacity: 1;
  transform: translateY(0);
}

.modal, .popup-content {
  background: var(--card-bg);
  padding: 25px;
  border-radius: 12px;
  width: 90%;
  max-width: 450px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  color: var(--text);
  text-align: center;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(106, 13, 173, 0.2);
}

.modal h3, .popup-content h3 {
  color: var(--primary-light);
  margin-bottom: 10px;
  font-size: 1.5rem;
}

.modal input, .popup-content input, .modal textarea {
  width: 100%;
  padding: 12px 15px;
  border-radius: 8px;
  border: 1px solid #444;
  background: #2a2a2a;
  color: var(--text);
  font-size: 16px;
  transition: all 0.3s ease;
}

.modal input:focus, .popup-content input:focus, .modal textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 2px rgba(106, 13, 173, 0.3);
}

.modal button, .popup-content button {
  padding: 12px;
  border-radius: 8px;
  border: none;
  background: var(--primary);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.modal button:hover, .popup-content button:hover {
  background: var(--primary-light);
}

.modal .close, .popup-content .close-btn {
  background: var(--secondary);
}

.modal .close:hover, .popup-content .close-btn:hover {
  background: var(--secondary-light);
}

#toggle-password {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 18px;
  color: var(--text-secondary);
}
#toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 3000;
}

.toast {
  background: var(--card-bg);
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  opacity: 0;
  transform: translateX(100px);
  animation: slideIn 0.5s forwards, fadeOut 0.5s 3.5s forwards;
  display: flex;
  align-items: center;
  gap: 12px;
  border-left: 4px solid;
  min-width: 280px;
}

.toast.success {
  border-left-color: var(--success);
}

.toast.error {
  border-left-color: var(--error);
}

.toast.warning {
  border-left-color: var(--warning);
}

.toast.info {
  border-left-color: var(--info);
}

@keyframes slideIn {
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes fadeOut {
  to {
    opacity: 0;
    transform: translateX(100px);
  }
}


#footer {
  position: fixed;
  bottom: 10px;
  right: 20px;
  color: var(--text-secondary);
  font-size: 14px;
  text-align: right;
  z-index: 1000;
  pointer-events: none;
  background: rgba(30, 30, 30, 0.8);
  padding: 8px 15px;
  border-radius: 8px;
  backdrop-filter: blur(5px);
}

#footer a {
  pointer-events: auto;
  color: var(--primary-light);
  text-decoration: none;
  font-weight: 500;
  transition: all 0.3s ease;
}

#footer a:hover {
  color: var(--primary);
  text-decoration: underline;
}


#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
}

#loading-overlay.show {
  display: flex;
}

.spinner {
  width: 60px;
  height: 60px;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}

.spinner::before,
.spinner::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  animation: pulse 1.5s ease-in-out infinite;
}

.spinner::before {
  width: 100%;
  height: 100%;
  background: rgba(106, 13, 173, 0.2);
  animation-delay: 0s;
}

.spinner::after {
  width: 80%;
  height: 80%;
  background: rgba(106, 13, 173, 0.4);
  animation-delay: -0.5s;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(0.8);
    opacity: 0.7;
  }
  50% {
    transform: scale(1.2);
    opacity: 1;
  }
}

@media (max-width: 768px) {
  body {
    padding-top: 70px;
  }
  
  .site-header {
    padding: 10px 15px;
  }
  
  .header-left img {
    height: 40px;
  }
  
  .nav-link {
    font-size: 14px;
    padding: 6px 12px;
  }
  
  .nav-link i {
    font-size: 16px;
    margin-right: 6px;
  }
  
  .header-right button {
    padding: 7px 12px;
    font-size: 14px;
  }
  
  .profile-img {
    width: 140px;
    height: 140px;
  }
  
  h1 {
    font-size: 1.8rem;
  }
  
  h2 {
    font-size: 1.1rem;
  }
  
  .description {
    font-size: 0.95rem;
    padding: 0 15px;
  }
  
  .actions {
    width: 85%;
    max-width: 280px;
  }
  
  .actions button {
    padding: 12px;
  }
  
  #suggestions-container {
    width: 95%;
  }
  
  .suggestion-card {
    padding: 15px;
  }
  
  .toast {
    min-width: 250px;
    padding: 12px 16px;
    font-size: 14px;
  }
  
  #footer {
    font-size: 12px;
    right: 10px;
    bottom: 5px;
  }
}

@media (max-width: 520px) {
  .header-center {
    position: static;
    transform: none;
    order: 3;
    width: 100%;
    text-align: center;
    margin-top: 10px;
  }
  
  .site-header {
    flex-wrap: wrap;
    padding: 10px;
  }
  
  .header-right {
    margin-left: auto;
  }
  
  .nav-link {
    font-size: 15px;
  }
  
  .profile-img {
    width: 120px;
    height: 120px;
  }
  
  h1 {
    font-size: 1.6rem;
  }
  
  h2 {
    font-size: 1rem;
  }
  
  .modal, .popup-content {
    padding: 20px 15px;
  }
}

@media (max-width: 380px) {
  .header-right {
    flex-direction: column;
    gap: 8px;
  }
  
  .header-right button {
    width: 100%;
    justify-content: center;
  }
}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-left">
    <img src="images/image.png" alt="Ibn-e-Sina Logo" style="border-radius: 50%;">
  </div>

  <div class="header-center">
    <a href="why-vote.html" class="nav-link"><i class="fas fa-question-circle"></i>Why Vote?</a>
  </div>

  <div class="header-right">
    <button id="login-btn"><i class="fab fa-google"></i>Sign in with Google</button>
    <button id="email-login-btn" class="secondary"><i class="fas fa-envelope"></i>Sign in with Email</button>
  </div>
</header>

<div class="profile-section">
  <img src="images/person.png" alt="Talal Mukhtar" class="profile-img">
  <h1>Vote For Talal Mukhtar</h1>
  <h2>Candidate for ISC Headboy</h2>
  <p class="description">Share your thoughts with me and I'll try my best to get back to you as soon as possible. Your feedback helps me improve and serve you better.</p>
</div>

<div class="actions">
  <button id="suggestion-btn"><i class="fas fa-lightbulb"></i>Submit Suggestion</button>
  <button id="complaint-btn"><i class="fas fa-exclamation-circle"></i>Submit Complaint</button>
</div>

<div id="suggestions-container"></div>

<div id="loading-overlay"><div class="spinner"></div></div>

<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <h3 id="modal-title"><i class="fas fa-edit"></i> Submit</h3>
    <input type="text" id="name" placeholder="Your Name">
    <input type="text" id="class" placeholder="Class">
    <input type="text" id="section" placeholder="Section">
    <input type="number" id="rollno" placeholder="Roll No">
    <textarea id="message" rows="4" placeholder="Your message"></textarea>
    <button id="submit-btn"><i class="fas fa-paper-plane"></i> Submit</button>
    <button class="close" id="close-modal"><i class="fas fa-times"></i> Cancel</button>
  </div>
</div>
  
<div id="email-modal" class="popup">
  <div class="popup-content">
    <h3><i class="fas fa-envelope"></i> Email Login / Signup</h3>
    <input type="email" id="email-input" placeholder="Email Address">
    <div style="position: relative;">
      <input type="password" id="password-input" placeholder="Password">
      <span id="toggle-password">👁️</span>
    </div>
    <button id="email-submit-btn"><i class="fas fa-sign-in-alt"></i> Login / Signup</button>
    <button id="reset-password-btn" style="background:#555;"><i class="fas fa-key"></i> Reset Password</button>
    <button class="close-btn"><i class="fas fa-times"></i> Cancel</button>
  </div>
</div>

<script>

function preloadCriticalResources() {
  const resources = [
    'images/image.png',
    'images/person.png'
  ];
  
  resources.forEach(resource => {
    const link = document.createElement('link');
    link.rel = 'preload';
    link.href = resource;
    link.as = 'image';
    document.head.appendChild(link);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  preloadCriticalResources();
  
  const favicon = document.querySelector('link[rel="icon"]');
  if (favicon) {
   
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.src = favicon.href;
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = 32;
      canvas.height = 32;
      const ctx = canvas.getContext('2d');
      
      ctx.beginPath();
      ctx.arc(16, 16, 16, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();
      
      ctx.drawImage(img, 0, 0, 32, 32);
      
      const newFavicon = document.createElement('link');
      newFavicon.rel = 'icon';
      newFavicon.href = canvas.toDataURL('image/png');
      document.head.removeChild(favicon);
      document.head.appendChild(newFavicon);
    };
    img.onerror = function() {
      console.log('Could not process favicon');
    };
  }
});

const firebaseConfig = {
    apiKey: "AIzaSyCGkF5OkclTr8Xjxe5XW3rjrP3vh4Dr2Ws",
    authDomain: "ibn-e-sina-school.firebaseapp.com",
    projectId: "ibn-e-sina-school",
    storageBucket: "ibn-e-sina-school.appspot.com",
    messagingSenderId: "897865466373",
    appId: "1:897865466373:web:107271a0b6b9e7fd36126c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById('login-btn');
const emailLoginBtn = document.getElementById('email-login-btn');
const suggestionBtn = document.getElementById('suggestion-btn');
const complaintBtn = document.getElementById('complaint-btn');
const modalBg = document.getElementById('modal-bg');
const modalTitle = document.getElementById('modal-title');
const submitBtn = document.getElementById('submit-btn');
const closeModal = document.getElementById('close-modal');
const suggestionsContainer = document.getElementById('suggestions-container');
const loadingOverlay = document.getElementById('loading-overlay');

const emailModal = document.getElementById('email-modal');
const emailInput = document.getElementById('email-input');
const passwordInput = document.getElementById('password-input');
const togglePassword = document.getElementById('toggle-password');
const emailSubmitBtn = document.getElementById('email-submit-btn');
const resetPasswordBtn = document.getElementById('reset-password-btn');
const emailCloseBtn = emailModal.querySelector('.close-btn');

let currentType = null;
let user = null;

function showLoading(){loadingOverlay.classList.add('show');}
function hideLoading(){loadingOverlay.classList.remove('show');}

function showToast(msg, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  let emoji = 'ℹ️';
  if (type === 'success') emoji = '✅';
  else if (type === 'error') emoji = '❌';
  else if (type === 'warning') emoji = '⚠️';
  
  toast.innerHTML = `<span class="toast-emoji">${emoji}</span> ${msg}`;
  document.getElementById('toast-container').appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}
  
loginBtn.onclick = async () => {
  if(!user){
    try{
      showLoading();
      const provider = new firebase.auth.GoogleAuthProvider();
      const res = await auth.signInWithPopup(provider);
      user = res.user;
      loginBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>Logout';
      emailLoginBtn.style.display='none';
      await loadSuggestions();
      showToast('Successfully signed in with Google', 'success');
    }catch(err){ 
      showToast(`Failed to sign in: ${err.message}`, 'error');
    }
    finally{hideLoading();}
  }else{
    try {
      await auth.signOut();
      user = null;
      loginBtn.innerHTML = '<i class="fab fa-google"></i>Sign in with Google';
      emailLoginBtn.style.display='inline-block';
      showToast('Successfully signed out', 'info');
    } catch (err) {
      showToast(`Failed to sign out: ${err.message}`, 'error');
    }
  }
};

emailLoginBtn.onclick = ()=>{ 
  emailModal.classList.add('show'); 
  emailInput.value=''; 
  passwordInput.value=''; 
};
togglePassword.onclick = ()=>{ 
  passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password'; 
  togglePassword.textContent = passwordInput.type === 'password' ? '👁️' : '🔒';
};
emailCloseBtn.onclick = ()=>emailModal.classList.remove('show');
emailModal.onclick = e=>{ if(e.target===emailModal) emailModal.classList.remove('show'); };

auth.onAuthStateChanged(u=>{
  user = u && u.emailVerified ? u : null;
  loginBtn.innerHTML = user ? '<i class="fas fa-sign-out-alt"></i>Logout' : '<i class="fab fa-google"></i>Sign in with Google';
  emailLoginBtn.style.display = user?'none':'inline-block';
  if(user) loadSuggestions();
});

function openModal(type){ 
  if(!user){ 
    showToast("Please sign in first!", 'warning'); 
    return; 
  } 
  currentType=type; 
  modalTitle.innerHTML = type==='suggestion' ? '<i class="fas fa-lightbulb"></i> Submit Suggestion' : '<i class="fas fa-exclamation-circle"></i> Submit Complaint'; 
  modalBg.classList.add('show');
}
suggestionBtn.onclick = ()=>openModal('suggestion');
complaintBtn.onclick = ()=>openModal('complaint');
closeModal.onclick = ()=>modalBg.classList.remove('show');

submitBtn.onclick = async () => {
  if (!user) { 
    showToast("Please sign in first!", 'warning'); 
    return; 
  }

  const name = document.getElementById('name').value.trim();
  const className = document.getElementById('class').value.trim();
  const section = document.getElementById('section').value.trim();
  const rollno = document.getElementById('rollno').value.trim();
  const message = document.getElementById('message').value.trim();

  if (!name || !className || !section || !rollno || !message) { 
    showToast("Please fill all fields!", 'warning'); 
    return; 
  }

  const limit = currentType === 'suggestion'
  ? 7 * 24 * 60 * 60 * 1000   // 1 week
  : 24 * 60 * 60 * 1000;      // 1 day

const limitRef = db.collection("submissionLimits").doc(`${user.uid}_${currentType}`);
const snap = await limitRef.get();

if (snap.exists) {
  const lastTime = snap.data().lastTime?.toDate();
  const now = new Date();

  if (lastTime && now - lastTime < limit) {
    const msLeft = limit - (now - lastTime);
    const hours = Math.floor(msLeft / (1000 * 60 * 60));
    const minutes = Math.floor((msLeft % (1000 * 60 * 60)) / (1000 * 60));
    showToast(`Please wait ${hours}h ${minutes}m before submitting another ${currentType}.`, 'warning');
    return;
  }
}


  submitBtn.disabled = true;
  showLoading();
  await new Promise(resolve => setTimeout(resolve, 50));

  try {
    const combinedText = `${name} ${className} ${section} ${rollno} ${message}`;

    const response = await fetch('https://vector.profanity.dev', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: combinedText })
    });
    const data = await response.json();
    if(data.score && data.score > 0.85){
      showToast("Your message contains inappropriate words. Please remove them.", 'warning');
      return;
    }

    await fetch('https://script.google.com/macros/s/AKfycbxbXiK4j4xHddht46t48_SeDTrIMHG01HTSIdRLnPSvph8eZ1R9iPI-wdGNfaCZjALf/exec',{
      method:'POST',
      body: JSON.stringify({name, class: className, section, rollno, message, type: currentType, email: user.email}),
      headers:{'Content-Type':'application/json'},
      mode:'no-cors'
    });

    await db.collection('submissions').add({
      name, class: className, section, rollno, message,
      type: currentType, email: user.email, upvotes:0, downvotes:0, upvoters:[], downvoters:[],
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });

    await limitRef.set({
  lastTime: firebase.firestore.FieldValue.serverTimestamp()
});
    modalBg.classList.remove('show');
    ['name','class','section','rollno','message'].forEach(id=>document.getElementById(id).value='');
    await loadSuggestions();
    showToast("Submitted successfully!", 'success');
    
    confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
    });

  } catch(err){ 
    showToast(`Submission failed: ${err.message}`, 'error'); 
  }
  finally{ 
    submitBtn.disabled=false; 
    hideLoading(); 
  }
};

async function loadSuggestions(){
  if(!user){ 
    suggestionsContainer.innerHTML='<p style="color: var(--text-secondary);">Please sign in to see suggestions.</p>'; 
    return; 
  }
  suggestionsContainer.innerHTML='<div style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Loading suggestions...</div>';
  try{
    const snapshot=await db.collection('submissions').where('type','==','suggestion').orderBy('timestamp', 'desc').get();
    if(snapshot.empty) {
      suggestionsContainer.innerHTML='<p style="color: var(--text-secondary);">No suggestions yet. Be the first to submit one!</p>';
      return;
    }
    
    suggestionsContainer.innerHTML='';
    snapshot.forEach(doc=>{
      const data=doc.data();
      const card=document.createElement('div');
      card.className='suggestion-card';
      card.innerHTML=`
        <strong>${data.name}</strong> (${data.class}-${data.section}) 
        <p>${data.message}</p>
        <div class="vote-container">
          <button class="vote-btn upvote"><i class="fas fa-arrow-up"></i></button>
          <span class="vote-count">${data.upvotes||0}</span>
          <button class="vote-btn downvote"><i class="fas fa-arrow-down"></i></button>
          <span class="vote-count">${data.downvotes||0}</span>
        </div>
      `;
      
      const docRef=db.collection('submissions').doc(doc.id);
      const upBtn = card.querySelector('.upvote');
      const downBtn = card.querySelector('.downvote');

      upBtn.onclick = async () => {
        if (!user) { showToast("Please sign in first!", 'warning'); return; }
        const docRef = db.collection('submissions').doc(doc.id);
        const snap = await docRef.get();
        const data = snap.data();

        if ((data.upvoters || []).includes(user.uid)) {
          await docRef.update({
            upvotes: firebase.firestore.FieldValue.increment(-1),
            upvoters: firebase.firestore.FieldValue.arrayRemove(user.uid)
          });
          showToast("Upvote removed", 'info');
        } else if ((data.downvoters || []).includes(user.uid)) {
          await docRef.update({
            downvotes: firebase.firestore.FieldValue.increment(-1),
            downvoters: firebase.firestore.FieldValue.arrayRemove(user.uid),
            upvotes: firebase.firestore.FieldValue.increment(1),
            upvoters: firebase.firestore.FieldValue.arrayUnion(user.uid)
          });
          showToast("Switched to upvote", 'info');
        } else {
          await docRef.update({
            upvotes: firebase.firestore.FieldValue.increment(1),
            upvoters: firebase.firestore.Value.arrayUnion(user.uid)
          });
          showToast("Upvoted successfully!", 'success');
        }
        loadSuggestions();
      };

      downBtn.onclick = async () => {
        if (!user) { showToast("Please sign in first!", 'warning'); return; }
        const docRef = db.collection('submissions').doc(doc.id);
        const snap = await docRef.get();
        const data = snap.data();

        if ((data.downvoters || []).includes(user.uid)) {
          await docRef.update({
            downvotes: firebase.firestore.FieldValue.increment(-1),
            downvoters: firebase.firestore.FieldValue.arrayRemove(user.uid)
          });
          showToast("Downvote removed", 'info');
        } else if ((data.upvoters || []).includes(user.uid)) {
          await docRef.update({
            upvotes: firebase.firestore.FieldValue.increment(-1),
            upvoters: firebase.firestore.FieldValue.arrayRemove(user.uid),
            downvotes: firebase.firestore.FieldValue.increment(1),
            downvoters: firebase.firestore.FieldValue.arrayUnion(user.uid)
          });
          showToast("Switched to downvote", 'info');
        } else {
          await docRef.update({
            downvotes: firebase.firestore.FieldValue.increment(1),
            downvoters: firebase.firestore.FieldValue.arrayUnion(user.uid)
          });
          showToast("Downvoted", 'info');
        }
        loadSuggestions();
      };

      suggestionsContainer.appendChild(card);
    });
  }catch(err){ 
    suggestionsContainer.innerHTML='<p style="color: var(--error);">Failed to load suggestions. Please try again later.</p>'; 
  }
}

  emailSubmitBtn.onclick=async ()=>{
  const email=emailInput.value.trim();
  const pass=passwordInput.value.trim();
  if(!email||!pass){ 
    showToast("Please fill all fields!", 'warning'); 
    return; 
  }
  try{
    showLoading();
    let cred;
    try{ 
      cred = await auth.signInWithEmailAndPassword(email,pass);
    }catch(e){
      cred = await auth.createUserWithEmailAndPassword(email,pass);
      await cred.user.sendEmailVerification();
      showToast("Account created. Please verify your email. Check your inbox or junk folder.", 'info');
      await auth.signOut();
      return;
    }
    if(!cred.user.emailVerified){
      showToast("Email not verified. Check your inbox or junk folder for the verification link.", 'warning');
      await cred.user.sendEmailVerification();
      await auth.signOut();
      return;
    }
    user=cred.user;
    showToast("Logged in successfully!", 'success');
    emailModal.classList.remove('show');
    loginBtn.innerHTML='<i class="fas fa-sign-out-alt"></i>Logout';
    emailLoginBtn.style.display='none';
    await loadSuggestions();
  }catch(err){ 
    showToast(`Authentication failed: ${err.message}`, 'error'); 
    await auth.signOut(); 
    user=null; 
  }
  finally{hideLoading();}
};

resetPasswordBtn.onclick=async ()=>{
  const email=emailInput.value.trim();
  if(!email){ 
    showToast("Please enter your email first", 'warning'); 
    return; 
  }
  try{
    showLoading();
    await auth.sendPasswordResetEmail(email);
    showToast("Password reset email sent. Check your inbox or junk folder.", 'info');
    await auth.signOut();
    user=null;
    emailModal.classList.remove('show');
  }catch(err){ 
    showToast(`Failed to send reset email: ${err.message}`, 'error');
  }
  finally{hideLoading();}
};
</script>

<footer id="footer">
  Made by Raahim Fahd, 9 Green | 
  <a href="https://github.com/iscsuggest/isc" target="_blank">Source code</a>
</footer>

<div id="toast-container"></div>

</body>
</html>
