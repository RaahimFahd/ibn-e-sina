<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ibn-e-Sina Portal</title>
<link rel="icon" href="images/image.png">
<style>
  html,body { margin:0;padding:0;font-family:sans-serif;height:100%; }
  body { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; transition: background 1s; color:white; }
  header { width:100%; display:flex; justify-content:space-between; align-items:center; padding:10px 20px; position:sticky; top:0; background:rgba(0,0,0,0.6); z-index:10; }
  header img { height:40px; }
  #loginBtn, #logoutBtn { background:#fff;color:#000;border:none;padding:8px 15px;border-radius:5px;cursor:pointer; }
  main { width:90%; max-width:800px; margin-top:20px; }
  h1 { text-align:center;margin-bottom:20px; }
  .modal-bg { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center; z-index:20; }
  .modal { background:#111;padding:20px;border-radius:10px; width:90%; max-width:400px; display:flex;flex-direction:column; }
  .modal input, .modal textarea { margin-bottom:10px;padding:8px;border-radius:5px;border:1px solid rgba(255,255,255,0.3); background:#222;color:white; width:100%; }
  #submitBtn { background:#4CAF50; color:white; border:none;padding:10px;border-radius:5px; cursor:pointer; }
  .suggestion-card { background:rgba(255,255,255,0.1); margin-bottom:10px; padding:10px; border-radius:8px; display:flex;flex-direction:column; }
  .vote { display:flex; justify-content:flex-start; margin-top:5px; gap:10px; }
  .vote button { background:transparent;color:white;border:none;cursor:pointer;font-size:16px; }
  .profile { display:flex;align-items:center;gap:10px;margin-bottom:10px; }
  .profile img { border-radius:50%;height:50px;width:50px;object-fit:cover; }
</style>
</head>
<body>
<header>
  <img src="images/image.png" alt="Ibn-e-Sina Logo">
  <button id="loginBtn">Sign in with Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
</header>

<main>
  <div class="profile">
    <img src="images/person.png" alt="Talal Mukhtar">
    <div>
      <h2>Talal Mukhtar</h2>
      <p>Ibn-e-Sina Headboy</p>
      <p>Share your thoughts with me and I'll try my best to get back to you asap</p>
    </div>
  </div>

  <h1 id="viewSuggestions">View Suggestions</h1>
  <div id="suggestionsContainer">Loading...</div>
  <button id="suggestionBtn">Add Suggestion</button>
  <button id="complaintBtn">Add Complaint</button>
</main>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <input type="text" id="name" placeholder="Name">
    <input type="text" id="class" placeholder="Class">
    <input type="text" id="section" placeholder="Section">
    <input type="number" id="rollno" placeholder="Roll No">
    <textarea id="message" rows="4" placeholder="Your message"></textarea>
    <button id="submitBtn">Submit</button>
    <p id="feedbackMessage"></p>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGkF5OkclTr8Xjxe5XW3rjrP3vh4Dr2Ws",
  authDomain: "ibn-e-sina-school.firebaseapp.com",
  projectId: "ibn-e-sina-school",
  storageBucket: "ibn-e-sina-school.appspot.com",
  messagingSenderId: "897865466373",
  appId: "1:897865466373:web:107271a0b6b9e7fd36126c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let user = null;
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const modalBg = document.getElementById('modalBg');
const submitBtn = document.getElementById('submitBtn');
const feedbackMessage = document.getElementById('feedbackMessage');
const suggestionsContainer = document.getElementById('suggestionsContainer');

function randomGradient(){
  const gradients = [
    'linear-gradient(135deg,#0a0a0a,#1a1a1a)',
    'linear-gradient(135deg,#0a0a0a,#001a33)',
    'linear-gradient(135deg,#0a0a0a,#003300)',
    'linear-gradient(135deg,#0a0a0a,#33001a)'
  ];
  document.body.style.background = gradients[Math.floor(Math.random()*gradients.length)];
}
randomGradient();

auth.onAuthStateChanged(u=>{
  user=u;
  if(user){ loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; }
  else{ loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; }
});

loginBtn.onclick = ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};

logoutBtn.onclick = ()=>auth.signOut();

function showModal(type){
  if(!user){ alert('Please login first'); return; }
  modalBg.style.display='flex';
  submitBtn.dataset.type=type;
}
document.getElementById('suggestionBtn').onclick = ()=>showModal('suggestion');
document.getElementById('complaintBtn').onclick = ()=>showModal('complaint');
modalBg.onclick = (e)=>{ if(e.target==modalBg) modalBg.style.display='none'; }

async function loadSuggestions(){
  const snapshot = await db.collection('suggestions').orderBy('timestamp','desc').get();
  suggestionsContainer.innerHTML='';
  snapshot.forEach(doc=>{
    if(doc.data().type !== 'suggestion') return;
    const votes = doc.data().votes || { up:{}, down:{} };
    const card = document.createElement('div');
    card.className='suggestion-card';
    card.innerHTML = `
      <strong>${doc.data().name}</strong> (${doc.data().class}-${doc.data().section})<br>
      ${doc.data().message}
      <div class="vote">
        <button class="upvote">⬆ ${Object.keys(votes.up||{}).length}</button>
        <button class="downvote">⬇ ${Object.keys(votes.down||{}).length}</button>
      </div>
    `;
    suggestionsContainer.appendChild(card);

    card.querySelector('.upvote').onclick = async ()=>{
      if(!user) return alert('Please login first');
      const uid=user.uid;
      if(votes.up[uid]) delete votes.up[uid]; else votes.up[uid]=true;
      delete votes.down[uid];
      await db.collection('suggestions').doc(doc.id).update({votes});
      loadSuggestions();
    };
    card.querySelector('.downvote').onclick = async ()=>{
      if(!user) return alert('Please login first');
      const uid=user.uid;
      if(votes.down[uid]) delete votes.down[uid]; else votes.down[uid]=true;
      delete votes.up[uid];
      await db.collection('suggestions').doc(doc.id).update({votes});
      loadSuggestions();
    };
  });
}

submitBtn.onclick = async ()=>{
  if(!user){ alert('Please login first'); return; }
  submitBtn.disabled=true;
  const type=submitBtn.dataset.type;
  const docData={
    type,
    name:document.getElementById('name').value,
    class:document.getElementById('class').value,
    section:document.getElementById('section').value,
    rollno:Number(document.getElementById('rollno').value),
    message:document.getElementById('message').value,
    timestamp:firebase.firestore.FieldValue.serverTimestamp(),
    votes:{up:{},down:{}}
  };
  try{
    await db.collection('suggestions').add(docData);
    feedbackMessage.textContent="✅ Submitted successfully!";
    modalBg.style.display='none';
    document.getElementById('name').value='';
    document.getElementById('class').value='';
    document.getElementById('section').value='';
    document.getElementById('rollno').value='';
    document.getElementById('message').value='';
    loadSuggestions();
  }catch(e){
    console.error(e);
    feedbackMessage.textContent="❌ Error submitting form";
  }
  setTimeout(()=>{feedbackMessage.textContent=''; submitBtn.disabled=false;},3000);
};

loadSuggestions();
</script>
</body>
</html>
